import{a as M,M as O,T as j}from"./TransactionSchedule-6AryLIuK.js";import{B as U,g as P}from"./Button-Cr3kI2Fa.js";import{_ as E,r as m,a as l,o as c,d,b as e,k as D,g,t as s,f as r,K as h,F as b,h as v,L as T,e as p,n as y,l as S,B as F,M as Y,v as z,i as C,w as R}from"./app-KLFPBacJ.js";import{D as L}from"./index-qaPES-kX.js";import{l as N,a as H,b as V,p as q,d as k,i as K}from"./helpers-C8PqwG3r.js";import{s as Q}from"./select2-8otZJJuH.js";Q();N(window.YAFFA.language);const G={components:{TransactionSchedule:j,MathInput:O,DatePicker:L,Button:U,AlertErrors:M},props:{action:String,initialCallback:{type:String,default:"create"},transaction:Object,simplified:{type:Boolean,default:!1},fromModal:{type:Boolean,default:!1}},data(){let t={};return t.form=new P({fromModal:this.fromModal,transaction_type:"Buy",config_type:"investment",date:V(),comment:null,schedule:!1,budget:!1,reconciled:!1,config:{},schedule_config:{frequency:"DAILY",interval:1}}),t.account_currency=null,t.investment_currency=null,t.csrfToken=window.csrfToken,t.callback=this.initialCallback,t.callbackOptions=[{value:"create",label:__("Add an other transaction"),enabled:!0},{value:"clone",label:__("Clone this transaction"),enabled:!0},{value:"show",label:__("Show this transaction"),enabled:!0},{value:"returnToPrimaryAccount",label:__("Return to selected account"),enabled:!0},{value:"returnToDashboard",label:__("Return to dashboard"),enabled:!0},{value:"back",label:__("Return to previous page"),enabled:!0}],t.locale=window.YAFFA.locale,t},computed:{total(){return(this.form.config.quantity||0)*(this.form.config.price||0)+(this.form.config.dividend||0)-((this.form.config.commission||0)+(this.form.config.tax||0))*this.transactionTypeSettings.amount_multiplier},transactionTypeSettings(){return this.transactionTypes.find(t=>t.name===this.form.transaction_type)||{}},currency(){return this.account_currency||this.investment_currency},activeCallbackOptions(){return this.callbackOptions.filter(t=>t.enabled)},datePickerInitialPage(){let t=this.form.date||new Date;return typeof t=="string"&&(t=new Date(t)),{year:t.getFullYear(),month:t.getMonth()}},isBaseSettingsEditsAllowed(){return["create","clone","finalize"].includes(this.action)}},created(){this.initializeTransaction(),this.transactionTypes=[{name:"Buy",quantity:!0,price:!0,dividend:!1,amount_multiplier:-1},{name:"Sell",quantity:!0,price:!0,dividend:!1,amount_multiplier:1},{name:"Add shares",quantity:!0,price:!1,dividend:!1,amount_multiplier:null},{name:"Remove shares",quantity:!0,price:!1,dividend:!1,amount_multiplier:null},{name:"Dividend",quantity:!1,price:!1,dividend:!0,amount_multiplier:1},{name:"Interest yield",quantity:!1,price:!1,dividend:!0,amount_multiplier:1}];const t=new URLSearchParams(window.location.search);t.get("account")&&(this.form.config.account_id=t.get("account")),this.form.action=this.action},mounted(){let t=this;$("#account").select2({ajax:{url:"/api/assets/account/investment",dataType:"json",delay:150,data:function(n){return{q:n.term,transaction_type:t.form.transaction_type,currency_id:t.investment_currency?.id,_token:t.csrfToken}},processResults:function(n){return{results:n}},cache:!0},selectOnClose:!1,placeholder:__("Select account"),allowClear:!0,width:"resolve",theme:"bootstrap-5",dropdownParent:$(document.getElementById("modal-transaction-form-investment")||document.querySelector("body"))}).on("select2:select",function(n){const i=new Event("change",{bubbles:!0,cancelable:!0});n.target.dispatchEvent(i),$.ajax({url:"/api/assets/account/"+n.params.data.id,data:{_token:t.csrfToken}}).done(f=>{t.account_currency=f.config.currency})}).on("select2:unselect",function(){t.account_id=null,t.account_currency=null,t.account_currency_id=null}),this.getDefaultAccountDetails(this.form.config.account_id),$("#investment").select2({ajax:{url:"/api/assets/investment",data:function(n){return{q:n.term,currency_id:t.account_currency?.id,_token:t.csrfToken}},dataType:"json",delay:150,processResults:function(n){return{results:n}},cache:!0},selectOnClose:!1,placeholder:__("Select investment"),allowClear:!0,width:"resolve",theme:"bootstrap-5",dropdownParent:$(document.getElementById("modal-transaction-form-investment")||document.querySelector("body"))}).on("select2:select",function(n){const i=new Event("change",{bubbles:!0,cancelable:!0});n.target.dispatchEvent(i),$.ajax({url:route("investment.getDetails",{investment:n.params.data.id}),data:{_token:t.csrfToken}}).done(function(f){t.investment_currency=f.currency})}).on("select2:unselect",function(){t.investment_id=null,t.investment_currency=null}),this.getDefaultInvestmentDetails(this.form.config.investment_id),this.syncScheduleStartDate(this.form.schedule_config.start_date),K()},methods:{getDefaultAccountDetails(t){if(!t)return;const n=this;$.ajax({url:"/api/assets/account/"+this.form.config.account_id,data:{_token:n.csrfToken}}).done(i=>{$("#account").append(new Option(i.name,i.id,!0,!0)).trigger("change").trigger({type:"select2:select",params:{data:i}})})},getDefaultInvestmentDetails(t){if(!t)return;const n=this;$.ajax({url:route("investment.getDetails",{investment:t}),data:{_token:n.csrfToken}}).done(function(i){$("#investment").append(new Option(i.name,i.id,!0,!0)).trigger("change").trigger({type:"select2:select",params:{data:i}})})},copyDateObject(t){return t instanceof Date?t:t?new Date(t):null},initializeTransaction(){this.transaction&&Object.keys(this.transaction).length>0&&(this.form.id=this.transaction.id,this.form.transaction_type=this.transaction.transaction_type?.name,this.form.date=this.copyDateObject(this.transaction.date),this.form.comment=this.transaction.comment,this.form.schedule=this.transaction.schedule,this.form.budget=this.transaction.budget,this.form.reconciled=this.transaction.reconciled,this.form.config.quantity=this.transaction.config?.quantity,this.form.config.price=this.transaction.config?.price,this.form.config.commission=this.transaction.config?.commission,this.form.config.tax=this.transaction.config?.tax,this.form.config.dividend=this.transaction.config?.dividend,this.form.config.account_id=this.transaction.config.account_id,this.form.config.investment_id=this.transaction.config.investment_id,this.transaction.transaction_schedule&&(this.form.schedule_config.frequency=this.transaction.transaction_schedule.frequency,this.form.schedule_config.count=this.transaction.transaction_schedule.count,this.form.schedule_config.interval=this.transaction.transaction_schedule.interval,this.form.schedule_config.start_date=this.copyDateObject(this.transaction.transaction_schedule.start_date),this.form.schedule_config.next_date=this.copyDateObject(this.transaction.transaction_schedule.next_date),this.form.schedule_config.automatic_recording=this.transaction.transaction_schedule.automatic_recording,this.form.schedule_config.end_date=this.copyDateObject(this.transaction.transaction_schedule.end_date),this.form.schedule_config.inflation=this.transaction.transaction_schedule.inflation),this.action==="replace"&&(this.form.original_schedule_config={},this.form.original_schedule_config.frequency=this.form.schedule_config.frequency,this.form.original_schedule_config.count=this.form.schedule_config.count,this.form.original_schedule_config.interval=this.form.schedule_config.interval,this.form.original_schedule_config.inflation=this.form.schedule_config.inflation,this.form.original_schedule_config.start_date=this.copyDateObject(this.form.schedule_config.start_date),this.form.original_schedule_config.automatic_recording=this.form.schedule_config.automatic_recording,this.form.original_schedule_config.next_date=void 0,this.form.schedule_config.start_date=k(),this.form.schedule&&(this.form.schedule_config.next_date=k()),this.form.original_schedule_config.end_date=new Date(k().getTime()-1440*60*1e3))),this.form.action=this.action},transactionTypeChanged(){const t=this.transactionTypeSettings;t.quantity||(this.form.config.quantity=null),t.price||(this.form.config.price=null),t.dividend||(this.form.config.dividend=null)},loadCallbackUrl(t){if(this.callback==="returnToDashboard"){location.href=window.route("home");return}if(this.callback==="new"){location.href=window.route("transaction.create",{type:"investment"});return}if(this.callback==="clone"){location.href=window.route("transaction.open",{transaction:t,action:"clone"});return}if(this.callback==="returnToPrimaryAccount"){location.href=window.route("account.history",{account:this.form.config.account_id});return}if(this.callback==="returnToSecondaryAccount"){location.href=window.route("account.history",{account:this.form.config.account_id});return}document.referrer?location.href=document.referrer:history.back()},onCancel(){return confirm(__("Are you sure you want to discard any changes?"))&&this.$emit("cancel"),!1},onSubmit(){if(this.action==="edit"){this.form.patch(window.route("api.transactions.updateInvestment",{transaction:this.form.id}),this.form).then(t=>{this.$emit("success",q(t.data.transaction),{callback:this.callback})});return}this.form.post(window.route("api.transactions.storeInvestment"),this.form).then(t=>{this.$emit("success",q(t.data.transaction),{callback:this.callback})})},syncScheduleStartDate(t){if(!this.form.original_schedule_config||!this.$refs.scheduleOriginal||this.$refs.scheduleOriginal.allowCustomization)return;let n=new Date(t);n.setDate(n.getDate()-1),this.form.original_schedule_config.end_date=V(n)},clearInvestmentDropdown(){$("#investment").val(null).trigger("change"),this.investment_currency=null},toFormattedCurrency:H},watch:{"form.schedule_config.start_date":function(t){this.syncScheduleStartDate(t)},transaction(t){this.form.reset(),this.initializeTransaction(),this.getDefaultAccountDetails(t.config.account_id),t.config.investment_id?this.getDefaultInvestmentDetails(t.config.investment_id):this.clearInvestmentDropdown()}}},J={id:"transactionFormInvestment"},W={class:"row"},X={class:"col-md-4"},Z={class:"card mb-3"},x={class:"card-header d-flex justify-content-between"},tt={class:"card-title"},et=["title"],nt={class:"card-body"},ot={class:"row"},st={class:"col-md-8 mb-2"},it={class:"form-group"},at={for:"transaction_type",class:"form-label"},ct=["disabled"],lt=["value"],rt={key:0,class:"col d-flex justify-content-between gap-2 mb-0"},dt=["disabled"],ut=["title","data-toggle"],mt={class:"col-md-8"},ft={class:"card mb-3"},ht={class:"card-header"},_t={class:"card-title"},gt={class:"card-body"},bt={class:"row"},vt={class:"col-6 col-sm-2 mb-3 mb-sm-0 d-flex justify-content-center"},pt=["disabled"],yt={class:"btn btn-outline-success",for:"checkbox-investment-transaction-reconciled"},kt={class:"block-label",for:"investment-date"},wt=["disabled","value"],Dt={for:"investment-comment",class:"block-label"},Tt={class:"row"},St={class:"col-md-4"},Ct={class:"card mb-3"},Vt={class:"card-header"},qt={class:"card-title"},At={class:"card-body"},It={class:"row mb-3"},Bt={class:"col-12 mb-3"},Mt={class:"form-group"},Ot={for:"account",class:"form-label"},jt={class:"col-12 mb-2"},Ut={class:"form-group"},Pt={for:"investment",class:"form-label"},Et={class:"row"},Ft={class:"col-8"},Yt={class:"col-4"},zt={key:0,class:"me-1",dusk:"transaction-total-value"},Rt={key:1},Lt={class:"col-md-8"},Nt={class:"card mb-3"},Ht={class:"card-header"},Kt={class:"card-title"},Qt={class:"card-body"},Gt={class:"row"},Jt={class:"col-md-6 mb-3"},Wt={class:"form-group"},Xt={for:"transaction_quantity",class:"form-label"},Zt={class:"col-md-6 mb-3"},$t={class:"form-group"},xt={for:"transaction_price",class:"form-label"},te={class:"row"},ee={class:"col-md-6 mb-3"},ne={class:"form-group"},oe={for:"transaction_commission",class:"form-label"},se={class:"col-md-6 mb-3"},ie={class:"form-group"},ae={for:"transaction_tax",class:"form-label"},ce={class:"row"},le={class:"col-md-6"},re={class:"form-group"},de={for:"transaction_dividend",class:"form-label"},ue={class:"card mb-3"},me={class:"card-body"},fe={class:"row"},he={class:"d-none d-md-block col-md-10"},_e={dusk:"action-after-save-desktop-button-group"},ge={class:"btn-group"},be={class:"btn btn-secondary",disabled:""},ve=["value"],pe={class:"col-12 d-block d-md-none"},ye={class:"form-label block-label",for:"callback-selector-mobile-investment"},ke=["value"],we={class:"col-12 col-md-2 text-end align-self-end"};function De(t,n,i,f,Te,a){const A=m("AlertErrors"),I=m("DatePicker"),u=m("MathInput"),w=m("transaction-schedule"),B=m("Button");return c(),l("div",J,[d(A,{form:t.form,message:t.__("There were some problems with your input.")},null,8,["form","message"]),e("form",{"accept-charset":"UTF-8",onSubmit:n[16]||(n[16]=R((...o)=>a.onSubmit&&a.onSubmit(...o),["prevent"])),autocomplete:"off"},[e("div",W,[e("div",X,[e("div",Z,[e("div",x,[e("div",tt,s(t.__("Settings")),1),e("span",{class:"fa fa-info-circle text-primary","data-bs-toggle":"tooltip","data-bs-placement":"right",title:t.__("These settings cannot be changed after saving the transaction.")},null,8,et)]),e("div",nt,[e("div",ot,[e("div",st,[e("div",it,[e("label",at,s(t.__("Transaction type")),1),r(e("select",{id:"transaction_type",class:"form-select","onUpdate:modelValue":n[0]||(n[0]=o=>t.form.transaction_type=o),disabled:!a.isBaseSettingsEditsAllowed,onChange:n[1]||(n[1]=o=>a.transactionTypeChanged(o))},[(c(!0),l(b,null,v(t.transactionTypes,o=>(c(),l("option",{key:o.name,value:o.name},s(o.name),9,lt))),128))],40,ct),[[h,t.form.transaction_type]])])]),i.simplified?g("",!0):(c(),l("div",rt,[r(e("input",{class:"btn-check",disabled:t.form.reconciled||!a.isBaseSettingsEditsAllowed,id:"checkbox-investment-transaction-schedule",type:"checkbox",autocomplete:"off",value:"1","onUpdate:modelValue":n[2]||(n[2]=o=>t.form.schedule=o)},null,8,dt),[[T,t.form.schedule]]),e("label",{class:"btn btn-outline-dark w-100",dusk:"checkbox-transaction-schedule",for:"checkbox-investment-transaction-schedule",title:i.action==="replace"?t.__("You cannot change schedule settings for this type of action"):"","data-toggle":i.action==="replace"?"tooltip":""},[n[17]||(n[17]=e("span",{class:"fa-solid fa-arrows-rotate"},null,-1)),n[18]||(n[18]=e("br",null,null,-1)),p(" "+s(t.__("Scheduled")),1)],8,ut)]))])])])]),e("div",mt,[e("div",ft,[e("div",ht,[e("div",_t,s(t.__("Properties")),1)]),e("div",gt,[e("div",bt,[e("div",vt,[r(e("input",{class:"btn-check",disabled:t.form.schedule,id:"checkbox-investment-transaction-reconciled",type:"checkbox",autocomplete:"off",value:"1","onUpdate:modelValue":n[3]||(n[3]=o=>t.form.reconciled=o)},null,8,pt),[[T,t.form.reconciled]]),e("label",yt,[n[19]||(n[19]=e("span",{class:"fa fa-check"},null,-1)),n[20]||(n[20]=e("br",null,null,-1)),p(" "+s(t.__("Reconciled")),1)])]),e("div",{class:y(["col-6 col-sm-2 mb-3 mb-sm-0",{"has-error":t.form.errors.has("date")}])},[e("label",kt,s(t.__("Date")),1),d(I,{columns:2,"initial-page":a.datePickerInitialPage,masks:{L:"YYYY-MM-DD",modelValue:"YYYY-MM-DD"},mode:"date",popover:{visibility:"click",showDelay:0,hideDelay:0},modelValue:t.form.date,"onUpdate:modelValue":n[4]||(n[4]=o=>t.form.date=o),modelModifiers:{string:!0}},{default:S(({inputValue:o,inputEvents:_})=>[e("input",F({class:"form-control",disabled:t.form.schedule,id:"investment-date",value:o},Y(_,!0)),null,16,wt)]),_:1},8,["initial-page","modelValue"])],2),e("div",{class:y(["col-12 col-sm-8 mb-0",t.form.errors.has("comment")?"has-error":""])},[e("label",Dt,s(t.__("Comment")),1),r(e("input",{class:"form-control",id:"investment-comment",maxlength:"255",type:"text","onUpdate:modelValue":n[5]||(n[5]=o=>t.form.comment=o)},null,512),[[z,t.form.comment]])],2)])])])])]),e("div",Tt,[e("div",St,[e("div",Ct,[e("div",Vt,[e("div",qt,s(t.__("Details")),1)]),e("div",At,[e("div",It,[e("div",Bt,[e("div",Mt,[e("label",Ot,s(t.__("Account")),1),r(e("select",{class:"form-select",id:"account","onUpdate:modelValue":n[6]||(n[6]=o=>t.form.config.account_id=o),style:{width:"100% !important"}},null,512),[[h,t.form.config.account_id]])])]),e("div",jt,[e("div",Ut,[e("label",Pt,s(t.__("Investment")),1),r(e("select",{class:"form-control",id:"investment","onUpdate:modelValue":n[7]||(n[7]=o=>t.form.config.investment_id=o),style:{width:"100% !important"}},null,512),[[h,t.form.config.investment_id]])])])]),e("dl",Et,[e("dt",Ft,s(t.__("Total cashflow value")),1),e("dd",Yt,[a.currency?(c(),l("span",zt,s(a.toFormattedCurrency(a.total,this.locale,a.currency)),1)):(c(),l("span",Rt,s(a.total),1))])])])])]),e("div",Lt,[e("div",Nt,[e("div",Ht,[e("div",Kt,s(t.__("Details")),1)]),e("div",Qt,[e("div",Gt,[e("div",Jt,[e("div",Wt,[e("label",Xt,s(t.__("Quantity")),1),d(u,{class:"form-control",id:"transaction_quantity",modelValue:t.form.config.quantity,"onUpdate:modelValue":n[8]||(n[8]=o=>t.form.config.quantity=o),disabled:!a.transactionTypeSettings.quantity},null,8,["modelValue","disabled"])])]),e("div",Zt,[e("div",$t,[e("label",xt,s(t.__("Price")),1),d(u,{class:"form-control",id:"transaction_price",modelValue:t.form.config.price,"onUpdate:modelValue":n[9]||(n[9]=o=>t.form.config.price=o),disabled:!a.transactionTypeSettings.price},null,8,["modelValue","disabled"])])])]),e("div",te,[e("div",ee,[e("div",ne,[e("label",oe,s(t.__("Commission")),1),d(u,{class:"form-control",id:"transaction_commission",modelValue:t.form.config.commission,"onUpdate:modelValue":n[10]||(n[10]=o=>t.form.config.commission=o)},null,8,["modelValue"])])]),e("div",se,[e("div",ie,[e("label",ae,s(t.__("Tax")),1),d(u,{class:"form-control",id:"transaction_tax",modelValue:t.form.config.tax,"onUpdate:modelValue":n[11]||(n[11]=o=>t.form.config.tax=o)},null,8,["modelValue"])])])]),e("div",ce,[e("div",le,[e("div",re,[e("label",de,s(t.__("Dividend")),1),d(u,{class:"form-control",id:"transaction_dividend",modelValue:t.form.config.dividend,"onUpdate:modelValue":n[12]||(n[12]=o=>t.form.config.dividend=o),disabled:!a.transactionTypeSettings.dividend},null,8,["modelValue","disabled"])])])])])])])]),t.form.schedule?(c(),D(w,{key:0,isSchedule:t.form.schedule,isBudget:!1,schedule:t.form.schedule_config,form:t.form},null,8,["isSchedule","schedule","form"])):g("",!0),t.form.schedule&&i.action==="replace"?(c(),D(w,{key:1,withCheckbox:!0,title:t.__("Update base schedule"),allowCustomization:!1,ref:"scheduleOriginal",isSchedule:t.form.schedule,isBudget:!1,schedule:t.form.original_schedule_config,form:t.form},null,8,["title","isSchedule","schedule","form"])):g("",!0),e("div",ue,[e("div",me,[e("div",fe,[e("div",he,[r(e("div",_e,[e("div",ge,[e("button",be,s(t.__("Action after saving")),1),(c(!0),l(b,null,v(a.activeCallbackOptions,o=>(c(),l("button",{key:o.id,class:y(["btn btn-outline-dark",{active:t.callback===o.value}]),type:"button",value:o.value,onClick:n[13]||(n[13]=_=>t.callback=_.currentTarget.getAttribute("value"))},s(o.label),11,ve))),128))])],512),[[C,!i.fromModal]])]),e("div",pe,[r(e("div",null,[e("label",ye,s(t.__("Action after saving")),1),r(e("select",{class:"form-control","onUpdate:modelValue":n[14]||(n[14]=o=>t.callback=o),id:"callback-selector-mobile-investment"},[(c(!0),l(b,null,v(a.activeCallbackOptions,o=>(c(),l("option",{key:o.id,value:o.value},s(o.label),9,ke))),128))],512),[[h,t.callback]])],512),[[C,!i.fromModal]])]),e("div",we,[e("button",{class:"btn btn-sm btn-default",onClick:n[15]||(n[15]=(...o)=>a.onCancel&&a.onCancel(...o)),type:"button"},s(t.__("Cancel")),1),d(B,{class:"btn btn-primary ms-2",disabled:t.form.busy,form:t.form,id:"transactionFormInvestment-Save"},{default:S(()=>[p(s(t.__("Save")),1)]),_:1},8,["disabled","form"])])])])])],32)])}const Be=E(G,[["render",De],["__scopeId","data-v-85023fa1"]]);export{Be as T};
