import"./dataTables.bootstrap5-C_qjeAEr.js";import"./responsive.bootstrap5-Ct7FWSHK.js";import{t as c,d as l,e as P,c as x}from"./dataTableHelper-DPRPCEc4.js";import{t as g,p as C,i as D,a as m}from"./helpers-uU3f7Ngr.js";import{D as j}from"./DateRangePicker-BBP1Q5Mi.js";import H from"./presetDates-Ct9BMwxE.js";import{_ as I,r as S,a as B,o as k,b as r,t as F,d as A,c as N}from"./app-QU5FfaO6.js";import{Q as Y}from"./Modal-ByczzkQD.js";import{T as q}from"./TransactionFormStandard-xHrQL7Iy.js";import{T as O}from"./TransactionFormInvestment-CGaaGiu0.js";import"./tslib.es6-CZM0TROl.js";import"./Datepicker-CU1wOnOT.js";import"./ActionButtonBar-Cvu4hr7f.js";import"./select2-DpGVDFvV.js";import"./TransactionSchedule-Bx7Cc8cD.js";import"./index-D0jneP2x.js";import"./defineProperty-CegpTSss.js";import"./Button-BO84qPxI.js";const G={name:"CreateStandardTransactionModal",components:{TransactionFormStandard:q},props:{transaction:{type:Object,default:{transaction_type:{name:"withdrawal"},date:new Date,schedule:!1,budget:!1,reconciled:!1,comment:null,config:{account_from_id:null,account_to_id:null,amount_from:null,amount_to:null}}}},data(){let t={action:"create"};return t.transactionData=Object.assign({},this.transaction),t},methods:{onCancel(){this.modal.hide()},onSuccess(t){let e=new CustomEvent("toast",{detail:{header:__("Success"),headerSmall:g(t.id,__("Go to transaction")),body:__("Transaction added."),toastClass:"bg-success"}});window.dispatchEvent(e);let a=new CustomEvent("transaction-created",{detail:{transaction:t}});window.dispatchEvent(a),this.modal.hide()},onInitiateEnterInstance(t){this.action="enter",this.transactionData=t,this.modal.show()},onInitiateCreateDraft(t){this.action="create",this.transactionData=t,this.modal.show()}},mounted(){let t=this;window.addEventListener("initiateEnterInstance",function(e){e.detail.transaction.config_type==="standard"&&t.onInitiateEnterInstance(e.detail.transaction)}),window.addEventListener("initiateCreateFromDraft",function(e){e.detail.type==="standard"&&t.onInitiateCreateDraft(e.detail.transaction)}),this.modal=new coreui.Modal(document.getElementById("modal-transaction-form-standard"))},computed:{modalTitle(){return new Map([["create",__("Add new transaction")],["edit",__("Modify existing transaction")],["clone",__("Clone existing transaction")],["enter",__("Enter scheduled transaction instance")],["replace",__("Clone scheduled transaction and close base item")]]).get(this.action)}}},U={class:"modal fade",id:"modal-transaction-form-standard"},V={class:"modal-dialog modal-xxl"},z={class:"modal-content"},Q={class:"modal-header"},X={class:"modal-title"},K={class:"modal-body"};function W(t,e,a,s,n,i){const o=S("transaction-form-standard");return k(),B("div",U,[r("div",V,[r("div",z,[r("div",Q,[r("h5",X,F(i.modalTitle),1),e[0]||(e[0]=r("button",{type:"button",class:"btn-close","data-coreui-dismiss":"modal","aria-label":"Close"},null,-1))]),r("div",K,[A(o,{action:t.action,transaction:t.transactionData,simplified:!0,fromModal:!0,onCancel:i.onCancel,onSuccess:i.onSuccess},null,8,["action","transaction","onCancel","onSuccess"])])])])])}const J=I(G,[["render",W],["__scopeId","data-v-0fb9b1ed"]]),Z={name:"CreateInvestmentTransactionModal",components:{TransactionFormInvestment:O},props:{transaction:{type:Object,default:{transaction_type:{name:"Buy"},date:new Date,schedule:!1,budget:!1,reconciled:!1,comment:null,config:{account_id:null,investment_id:null,price:null,quantity:null,dividend:null,commission:null,tax:null}}}},data(){let t={action:"create"};return t.transactionData=Object.assign({},this.transaction),t},methods:{onCancel(){this.modal.hide()},onSuccess(t){let e=new CustomEvent("toast",{detail:{header:__("Success"),headerSmall:g(t.id,__("Go to transaction")),body:__("Transaction added."),toastClass:"bg-success"}});window.dispatchEvent(e);let a=new CustomEvent("transaction-created",{detail:{transaction:t}});window.dispatchEvent(a),this.modal.hide()},onInitiateEnterInstance(t){this.action="enter",this.transactionData=t,this.modal.show()},onInitiateCreateDraft(t){this.action="create",this.transactionData=t,this.modal.show()}},mounted(){let t=this;window.addEventListener("initiateEnterInstance",function(e){e.detail.transaction.config_type==="investment"&&t.onInitiateEnterInstance(e.detail.transaction)}),window.addEventListener("initiateCreateFromDraft",function(e){e.detail.type==="investment"&&t.onInitiateCreateDraft(e.detail.transaction)}),this.modal=new coreui.Modal(document.getElementById("modal-transaction-form-investment"))},computed:{modalTitle(){return new Map([["create",__("Add new transaction")],["edit",__("Modify existing transaction")],["clone",__("Clone existing transaction")],["enter",__("Enter scheduled transaction instance")],["replace",__("Clone scheduled transaction and close base item")]]).get(this.action)}}},tt={class:"modal fade",id:"modal-transaction-form-investment"},et={class:"modal-dialog modal-xxl"},at={class:"modal-content"},nt={class:"modal-header"},st={class:"modal-title"},it={class:"modal-body"};function ot(t,e,a,s,n,i){const o=S("transaction-form-investment");return k(),B("div",tt,[r("div",et,[r("div",at,[r("div",nt,[r("h5",st,F(i.modalTitle),1),e[0]||(e[0]=r("button",{type:"button",class:"btn-close","data-coreui-dismiss":"modal","aria-label":"Close"},null,-1))]),r("div",it,[A(o,{action:t.action,transaction:t.transactionData,simplified:!0,fromModal:!0,onCancel:i.onCancel,onSuccess:i.onSuccess},null,8,["action","transaction","onCancel","onSuccess"])])])])])}const ct=I(Z,[["render",ot],["__scopeId","data-v-86848141"]]),f="#scheduleTable",u="#historyTable";let d={ready:function(){for(let t in d)if(d[t]===!1)return!1;return!0}};for(let t in window.filters)t==="date_preset"&&window.filters[t]==="none"||(d[t]=!1);d.ready()||document.getElementById("reload").setAttribute("disabled","disabled");const p=new j(document.getElementById("dateRangePicker"),{allowOneSidedRange:!0,weekStart:1,todayBtn:!0,todayBtnMode:1,todayHighlight:!0,language:window.YAFFA.language,format:"yyyy-mm-dd",autohide:!0,buttonClass:"btn"}),E=function(t){return t.config_type==="standard"?typeof t.cashflow_value=="number"?t.current_cash_flow=t.cashflow_value:t.config.account_from_id===window.account.id?t.current_cash_flow=-t.config.amount_from:t.current_cash_flow=t.config.amount_to:t.config_type==="investment"&&(t.current_cash_flow=t.cashflow_value??0),t};let T=!0,_=!1,v=$(u).DataTable({ajax:function(t,e,a){if(T){T=!1,e({data:[]});return}const s=p.getDates("yyyy-mm-dd"),n=new URLSearchParams;s[0]&&n.append("date_from",s[0]),s[1]&&n.append("date_to",s[1]),n.append("accounts[]",account.id),fetch("/api/transactions?"+n,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest","X-CSRF-TOKEN":window.csrfToken}}).then(i=>i.json()).then(i=>{let o=i.data.map(C).map(E);e({data:o})})},columns:[c.dateFromCustomField("date",__("Date"),window.YAFFA.locale),{data:"reconciled",title:'<span title="'+__("Reconciled")+'">R</span>',className:"text-center",render:function(t,e,a){return e==="filter"?!a.schedule&&(a.transaction_type.type==="standard"||a.transaction_type.type==="investment")?a.reconciled?__("Reconciled"):__("Uncleared"):__("Unavailable"):!a.schedule&&(a.transaction_type.type==="standard"||a.transaction_type.type==="investment")?a.reconciled?'<i class="fa fa-check-circle text-success reconcile" data-reconciled="true" data-id="'+a.id+'"></i>':'<i class="fa fa-circle text-info reconcile" data-reconciled="false" data-id="'+a.id+'"></i>':'<i class="fa fa-circle text-muted"></i>'},orderable:!1},c.payee,c.category,c.amountCustom,c.comment,c.tags,{data:"id",title:__("Actions"),render:function(t){return l(t,"quickView")+l(t,"show")+l(t,"edit")+l(t,"clone")+l(t,"delete")},className:"dt-nowrap",orderable:!1,searchable:!1}],createdRow:function(t,e){e.current_cash_flow>0?$("td",t).eq(4).addClass("text-success"):e.current_cash_flow<0&&$("td",t).eq(4).addClass("text-danger"),e.config_type==="standard"&&e.categories.length===0&&$("td",t).eq(3).addClass("text-muted text-italic")},initComplete:function(){var t=this.api();setTimeout(function(){t.columns.adjust().draw()},2e3)},order:[[0,"asc"]],responsive:!0,deferRender:!0,scrollY:"400px",scrollCollapse:!0,stateSave:!1,processing:!0,paging:!1}),M=$(f).DataTable({ajax:{url:"/api/transactions/get_scheduled_items/schedule?accountEntity="+window.account.id+"&accountSelection=selected",type:"GET",dataSrc:function(t){return t.transactions.map(C).map(E).filter(e=>e.transaction_schedule.next_date)},deferRender:!0},columns:[c.dateFromCustomField("transaction_schedule.next_date",__("Next date"),window.YAFFA.locale),c.payee,c.category,c.amountCustom,c.comment,c.tags,{data:"id",title:__("Actions"),defaultContent:"",render:function(t){return'<button class="btn btn-xs btn-success create-transaction-from-draft" data-draft="'+t+'" type="button" title="'+__("Adjust and enter instance")+'"><i class="fa fa-fw fa-pencil"></i></button> '+l(t,"skip")+l(t,"edit")+l(t,"clone")+l(t,"replace")+l(t,"delete")},className:"dt-nowrap",orderable:!1,searchable:!1}],createdRow:function(t,e){e.transaction_schedule.next_date&&(e.transaction_schedule.next_date<new Date(new Date().setHours(0,0,0,0))?$(t).addClass("table-danger"):e.transaction_schedule.next_date<new Date(new Date().setHours(24,0,0,0))&&$(t).addClass("table-warning")),e.current_cash_flow>0?$("td",t).eq(3).addClass("text-success"):e.current_cash_flow<0&&$("td",t).eq(3).addClass("text-danger"),e.categories.length===0&&$("td",t).eq(2).addClass("text-muted text-italic")},initComplete:function(){const t=this.api();setTimeout(function(){t.columns.adjust().draw()},2e3)},order:[[0,"asc"]],responsive:!0,deferRender:!0,scrollY:"500px",scrollCollapse:!0,stateSave:!1,processing:!0,paging:!1});P(u);$(f).on("click","[data-skip]",function(){if($(this).hasClass("busy"))return!1;let t=Number(this.dataset.id);$(this).addClass("busy"),axios.patch("/api/transactions/"+t+"/skip").then(function(e){let a=$(f).dataTable().api().row(function(i,o,R){return Number(o.id)===t}),s=a.data(),n=e.data.transaction.transaction_schedule.next_date;if(n){s.transaction_schedule.next_date=new Date(n),a.data(s).draw();let i=new CustomEvent("toast",{detail:{header:__("Success"),headerSmall:g(t,__("Go to transaction")),body:__("Schedule instance skipped."),toastClass:"bg-success"}});window.dispatchEvent(i)}else{a.remove().draw();let i=new CustomEvent("toast",{detail:{header:__("Success"),headerSmall:g(t,__("Go to transaction")),body:__("Schedule instance skipped. This schedule has ended."),toastClass:"bg-success"}});window.dispatchEvent(i)}})});let h=function(){let t=document.getElementById("overviewOpeningBalance"),e=document.getElementById("overviewCurrentCash"),a=document.getElementById("overviewCurrentBalance");t.innerHTML=e.innerHTML=a.innerHTML='<i class="fa fa-fw fa-spinner fa-spin"></i>',axios.get("/api/account/balance/"+window.account.id).then(function(s){if(s.data.result==="busy"){t.innerHTML=e.innerHTML=a.innerHTML=`<i
                                 class="text-warning fa-solid fa-triangle-exclamation"
                                 title="${s.data.message}"
                         ></i>`,setTimeout(h,5e3);return}let n=s.data.accountBalanceData[0];t.innerText=m(n.config.opening_balance,window.YAFFA.locale,n.config.currency),e.innerText=m(n.cash,window.YAFFA.locale,window.YAFFA.baseCurrency),n.hasOwnProperty("cash_foreign")&&(e.innerText+=" / "+m(n.cash_foreign,window.YAFFA.locale,n.config.currency)),a.innerText=m(n.sum,window.YAFFA.locale,window.YAFFA.baseCurrency),n.hasOwnProperty("sum_foreign")&&(a.innerText+=" / "+m(n.sum_foreign,window.YAFFA.locale,n.config.currency))}).catch(function(s){t.innerHTML=e.innerHTML=a.innerHTML=`<i
                                 class="text-danger fa-solid fa-triangle-exclamation"
                                 title="${__("Error while retrieving data")}"
                         ></i>`;let n=new CustomEvent("toast",{detail:{header:__("Error while fetching account balance data"),body:s.message,toastClass:"bg-danger"}});window.dispatchEvent(n)})};h();x(u,h);x(f);$(u).on("click","i.reconcile",function(){if($(this).hasClass("fa-spinner"))return!1;const t=$(this).data("reconciled"),e=Number($(this).data("id"));$(this).removeClass().addClass("fa fa-spinner fa-spin"),$.ajax({type:"PUT",url:"/api/transaction/"+e+"/reconciled/"+(t?0:1),data:{_token:csrfToken},dataType:"json",context:this,success:function(a){let s=$(u).dataTable().api().row(function(i,o,R){return o.id===e}),n=s.data();n.reconciled=!t,s.data(n).draw()}})});$("input[name=reconciled]").on("change",function(){$(u).DataTable().column(1).search(this.value).draw()});function b(){document.getElementById("reload").setAttribute("disabled","disabled"),v.ajax.reload(function(){document.getElementById("reload").removeAttribute("disabled"),D()})}$("#reload").on("click",b);$("#clear_dates").on("click",function(){p.setDates({clear:!0},{clear:!0})});document.getElementById("dateRangePickerPresets").addEventListener("change",function(t){_=!0;const e=this.options[this.selectedIndex].value,a=new Date;let s,n;const i=H[e];if(i){const o=i(a);s=o.start,n=o.end}else s={clear:!0},n={clear:!0};p.setDates(s,n),_=!1});let L=function(){let t=[];if(_){const e=document.getElementById("dateRangePickerPresets").value;e&&e!=="none"&&t.push("date_preset="+e)}else{const e=p.getDates("yyyy-mm-dd");e[0]&&t.push("date_from="+e[0]),e[1]&&t.push("date_to="+e[1])}window.history.pushState("","",window.location.origin+window.location.pathname+"?"+t.join("&"))};document.getElementById("date_from").addEventListener("changeDate",function(){_||(document.getElementById("dateRangePickerPresets").value="none"),L()});document.getElementById("date_to").addEventListener("changeDate",function(){_||(document.getElementById("dateRangePickerPresets").value="none"),L()});if(filters.date_from||filters.date_to){const t=filters.date_from?filters.date_from:{clear:!0},e=filters.date_to?filters.date_to:{clear:!0};p.setDates(t,e),d.date_from=!0,d.date_to=!0,d.ready()&&b()}else if(filters.date_preset&&filters.date_preset!=="none"){document.getElementById("dateRangePickerPresets").value=filters.date_preset;const t=new Event("change");document.getElementById("dateRangePickerPresets").dispatchEvent(t),d.date_preset=!0,d.ready()&&b()}else filters.date_preset&&filters.date_preset==="none"&&(d.date_preset=!0);$("#create-standard-transaction-button").on("click",function(){y=void 0;const t={transaction_type:{name:"withdrawal"},schedule:!1,budget:!1,date:new Date,config:{account_from_id:account.id}},e=new CustomEvent("initiateCreateFromDraft",{detail:{transaction:t,type:"standard"}});window.dispatchEvent(e)});let y;$("#create-investment-transaction-button").on("click",function(){y=void 0;const t={transaction_type:{name:"Buy"},schedule:!1,budget:!1,date:new Date,config:{account_id:account.id}},e=new CustomEvent("initiateCreateFromDraft",{detail:{transaction:t,type:"investment"}});window.dispatchEvent(e)});$(f).on("click","button.create-transaction-from-draft",function(){y=Number($(this).data("draft"));const e={...M.row($(this).parentsUntil("tr")).data()};e.schedule=!1,e.budget=!1,e.date=e.transaction_schedule.next_date;const a=new CustomEvent("initiateEnterInstance",{detail:{transaction:e}});window.dispatchEvent(a)});window.addEventListener("transaction-created",function(t){let e=E(C(t.detail.transaction));e.date=new Date(e.date),v.row.add(e).draw(),setTimeout(h,15e3),setTimeout(function(){v.columns.adjust().draw()},2e3),y&&M.ajax.reload()});document.getElementById("recalculateMonthlyCachedData").addEventListener("click",function(){if(this.classList.contains("busy"))return!1;this.classList.add("busy");const t=this;axios.put(window.route("api.account.updateMonthlySummary",{accountEntity:window.account.id})).then(function(e){const a=e.data;let s=new CustomEvent("toast",{detail:{header:a.result==="success"?__("Success"):__("Error"),body:a.message,toastClass:a.result==="success"?"bg-success":"bg-danger"}});window.dispatchEvent(s),setTimeout(h,5e3)}).catch(function(e){let a=new CustomEvent("toast",{detail:{header:__("Error"),body:e.message,toastClass:"bg-danger"}});window.dispatchEvent(a)}).finally(function(){t.classList.remove("busy")})});const w=N({});w.config.globalProperties.__=window.__;w.component("transaction-show-modal",Y);w.component("transaction-create-standard-modal",J);w.component("transaction-create-investment-modal",ct);w.mount("#app");$(document).ready(function(){D()});
