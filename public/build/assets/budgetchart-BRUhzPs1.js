import{u as j,t as C,c as I,b as L,D as q,V as X,e as U,L as E,X as R,h as P,a as z}from"./animated-BLhhOB8u.js";import{t as N}from"./kelly-1Af0simh.js";import{t as g,d as v,b as O,c as H}from"./dataTableHelper-BFrUsbwO.js";import{p as Q,c as V,i as W}from"./helpers-C8PqwG3r.js";import"./dataTables.bootstrap5-Csew7iXD.js";import"./select2-8otZJJuH.js";import"./tslib.es6-CZM0TROl.js";import"./app-KLFPBacJ.js";const f="#accountList",d="#categoryTree",Z=(e,n)=>e.reduce((t,i)=>t+i[n],0)/e.length,G=(e,n)=>{if(e.length===0)return e;let t=12;n==="quarter"?t=12:n==="year"&&(t=60);let i=null;for(let a=e.length;a>0;a--)if(e[a-1].actual){i=e[a-1].date;break}return i||(i=e[e.length-1].date),e.map(function(a,r){if(a.date>i)return r>0&&(a.movingAverage=e[r-1].movingAverage),a;const o=new Date(a.date.getTime());o.setMonth(o.getMonth()-t);const l=a.date,s=e.filter(function(c){return c.date>=o&&c.date<=l});return a.movingAverage=Z(s,"actual"),a})},w=document.getElementById("reload");j(C);j(N);window.chart=I("chartdiv",L);chart.numberFormatter.intlLocales=window.YAFFA.locale;chart.numberFormatter.numberFormat={style:"currency",currency:window.YAFFA.baseCurrency.iso_code,minimumFractionDigits:0};const h=chart.xAxes.push(new q);h.dataFields.category="period";h.baseInterval={timeUnit:"month",count:1};h.dateFormats.setKey("month","yyyy MMM");chart.yAxes.push(new X);const b=chart.series.push(new U);b.dataFields.valueY="actual";b.dataFields.dateX="date";b.name=__("Actual");b.tooltipText="[bold]"+__("Actual")+":[/] {valueY}";const m=chart.series.push(new E);m.strokeWidth=3;m.strokeDasharray="8,4";m.dataFields.valueY="budget";m.dataFields.dateX="date";m.name=__("Budget");m.tooltipText="[bold]"+__("Budget")+":[/] {valueY}";const _=chart.series.push(new E);_.strokeWidth=3;_.dataFields.valueY="movingAverage";_.dataFields.dateX="date";_.name=__("Moving average");_.tooltipText="[bold]"+__("Moving average")+":[/] {valueY}";const F=new R;F.series.push(m);F.series.push(b);F.series.push(_);chart.scrollbarX=F;chart.legend=new P;chart.cursor=new z;const S=document.getElementById("btnZoomIn");S&&S.addEventListener("click",function(){const e=new Date;h.zoomToDates(new Date(e.setMonth(e.getMonth()-13)),new Date(e.setMonth(e.getMonth()+26)))});let x=[],y=function(){w.disabled=!0;const e=$(d).jstree()?$(d).jstree("get_checked",!0):[];$.ajax({url:window.route("api.reports.budgetchart"),data:{categories:e.map(n=>n.id),accountSelection:$("input[name=table_filter_account_scope]:checked").val(),accountEntity:$(f).val()}}).done(function(n){n=n.map(function(i){return i.date=new Date(i.period),i}),x=n.slice();let t="month";e.some(function(i){if(i.original.default_aggregation==="quarter")return t="quarter",!1;if(i.original.default_aggregation==="year")return t="year",!0}),document.querySelector('input[name="chart_time_interval"][value="'+t+'"]').checked=!0,T(x)}).always(function(){w.disabled=!1}),window.table.ajax.reload(function(){W()})};function T(e){if(e.length===0){chart.data=[],chart.invalidateData();return}const n=document.querySelector('input[name="chart_time_interval"]:checked')?.value||"month";let t;if(n==="quarter"){t=e.reduce((o,l)=>{const s=Math.floor(l.date.getMonth()/3),c=o.find(D=>D.date.getFullYear()===l.date.getFullYear()&&Math.floor(D.date.getMonth()/3)===s);return typeof c>"u"?(o.push({date:new Date(l.date.getFullYear(),s*3),period:l.date.getFullYear()+" Q"+(s+1),actual:l.actual,budget:l.budget}),o):(c.actual||(c.actual=0),c.budget||(c.budget=0),c.actual+=l.actual,c.budget+=l.budget,o)},[]);const i=t[0].date,a=t[t.length-1].date;let r=new Date(i);for(;r<a;)t.find(o=>o.date.getFullYear()===r.getFullYear()&&Math.floor(o.date.getMonth()/3)===Math.floor(r.getMonth()/3))||t.push({date:new Date(r),period:r.getFullYear()+" Q"+(Math.floor(r.getMonth()/3)+1),actual:0,budget:0}),r.setMonth(r.getMonth()+3);h.baseInterval={timeUnit:"month",count:3}}else if(n==="year"){t=e.reduce((o,l)=>{const s=o.find(c=>c.date.getFullYear()===l.date.getFullYear());return typeof s>"u"?(o.push({date:new Date(l.date.getFullYear(),0),period:l.date.getFullYear().toString(),actual:l.actual,budget:l.budget}),o):(s.actual||(s.actual=0),s.budget||(s.budget=0),s.actual+=l.actual,s.budget+=l.budget,o)},[]);const i=t[0].date,a=t[t.length-1].date;let r=new Date(i);for(;r<a;)t.find(o=>o.date.getFullYear()===r.getFullYear())||t.push({date:new Date(r),period:r.getFullYear().toString(),actual:0,budget:0}),r.setFullYear(r.getFullYear()+1);h.baseInterval={timeUnit:"year",count:1}}else{t=e.slice();const i=t[0].date,a=t[t.length-1].date;let r=new Date(i);for(;r<a;)t.find(o=>o.date.getFullYear()===r.getFullYear()&&o.date.getMonth()===r.getMonth()&&o.date.getDate()===r.getDate())||t.push({date:new Date(r),period:r.toISOString().slice(0,7),actual:0,budget:0}),r.setMonth(r.getMonth()+1);h.baseInterval={timeUnit:"month",count:1}}t.sort((i,a)=>i.date-a.date),t=G(t,n),chart.data=t,chart.invalidateData()}w.addEventListener("click",y);document.querySelectorAll('input[name="chart_time_interval"]').forEach(function(e){e.addEventListener("change",function(){T(x)})});let M=!0;const A="#table";window.table=$(A).DataTable({ajax:{url:window.route("api.transactions.getScheduledItems",{type:"any"}),type:"GET",dataSrc:function(e){return e.transactions?e.transactions.map(Q).map(V):[]},data:function(){return M?(M=!1,{categories:[],category_required:1}):Object.assign({},{categories:$(d).jstree()?$(d).jstree("get_checked"):[],category_required:1,accountSelection:$("input[name=table_filter_account_scope]:checked").val(),accountEntity:$(f).val()})}},columns:[g.dateFromCustomField("transaction_schedule.start_date",__("Start date"),window.YAFFA.locale),{data:"transaction_schedule.rule",title:__("Schedule"),render:function(e){return e.toText()}},g.dateFromCustomField("transaction_schedule.next_date",__("Next date"),window.YAFFA.locale),g.iconFromBooleanField("schedule",__("Schedule")),g.iconFromBooleanField("budget",__("Budget")),g.iconFromBooleanField("transaction_schedule.active",__("Active")),{data:"transaction_type.type",title:__("Type"),render:function(e,n){return n==="filter"?e:e==="standard"?'<i class="fa fa-money text-primary" title="'+__("Standard")+'"></i>':'<i class="fa fa-line-chart text-primary" title="'+__("Investment")+'"></i>'},className:"text-center"},g.payee,g.category,g.amount,g.extra,{data:"id",title:__("Actions"),render:function(e,n,t){return v(e,"edit")+v(e,"clone")+v(e,"replace")+v(e,"delete")+(t.schedule?'<a href="'+window.route("transaction.open",{transaction:e,action:"enter"})+'" class="btn btn-xs btn-success" title="'+__("Edit and insert instance")+'"><i class="fa fa-fw fa-pencil"></i></a> <button class="btn btn-xs btn-warning data-skip" data-id="'+e+'" type="button" title="'+__("Skip current schedule")+'"><i class="fa fa-fw fa-forward"></i></i></button> ':"")},className:"dt-nowrap",orderable:!1,searchable:!1}],createdRow:function(e,n){n.transaction_schedule.next_date&&(n.transaction_schedule.next_date<new Date(new Date().setHours(0,0,0,0))?$(e).addClass("danger"):n.transaction_schedule.next_date<new Date(new Date().setHours(24,0,0,0))&&$(e).addClass("warning"))},order:[[0,"asc"]],deferRender:!0,scrollY:"400px",scrollCollapse:!0,stateSave:!1,processing:!0,paging:!1});O(A);H(A);let u={categories:{},account:void 0,ready:function(){for(let e in u.categories)if(u.categories[e]===!1)return!1;return u.account!==!1}};const k=new URLSearchParams(window.location.search),B=k.getAll("categories[]").map(e=>parseInt(e));B.forEach(e=>u.categories[e]=!1);const Y=k.has("accountEntity")?parseInt(k.get("accountEntity")):void 0;typeof Y<"u"&&(u.account=!1);let p=function(){let e=new URL(window.location.origin+window.location.pathname);$(f).val()&&e.searchParams.append("accountEntity",$(f).val()),$(d).jstree("get_checked").forEach(n=>e.searchParams.append("categories[]",n)),window.history.pushState("","",e.toString()),w.disabled=$(d).jstree("get_checked").length===0};$(d).jstree({core:{data:function(e,n){fetch("/api/assets/categories?withInactive=1").then(t=>t.json()).then(t=>{let i=t.map(function(a){return u.categories[a.id]!==void 0&&(u.categories[a.id]=!0),{id:a.id,parent:a.parent_id||"#",default_aggregation:a.default_aggregation,text:a.active?a.name:'<span class="text-muted" title="'+__("Inactive")+'">'+a.name+"</span>",full_name:a.full_name,icon:a.parent?a.active?"fa fa-check text-success":"fa fa-remove text-danger":"fa fa-folder text-info",state:{selected:B.includes(a.id)}}});n.call(this,i)})},themes:{dots:!1}},plugins:["checkbox"],checkbox:{keep_selected_style:!1}}).on("select_node.jstree",p).on("deselect_node.jstree",p).on("ready.jstree",function(){$(d).jstree("get_checked").length>0?u.ready()&&y():w.disabled=!0});$(f).select2({theme:"bootstrap-5",ajax:{url:"/api/assets/account",dataType:"json",delay:150,data:function(e){return{q:e.term,withInactive:!0}},processResults:function(e){return{results:e.map(function(n){return{id:n.id,text:n.name}})}},cache:!0},placeholder:__("Select account"),allowClear:!0}).on("select2:select",p).on("select2:unselect",p);typeof Y<"u"?$.ajax({url:"/api/assets/account/"+Y,data:{_token:window.csrfToken}}).done(e=>{$(f).append(new Option(e.name,e.id,!0,!0)).trigger("change").trigger({type:"select2:select",params:{data:{id:e.id,name:e.name}}}),u.account=!0,u.ready()&&$(d).jstree("get_checked").length>0&&y()}):u.ready()&&$(d).jstree("get_checked").length>0&&y();document.getElementById("all").addEventListener("click",function(){$(d).jstree("check_all"),p()});document.getElementById("clear").addEventListener("click",function(){$(d).jstree("uncheck_all"),p()});$("input[name=table_filter_account_scope]").on("change",function(){$(f).prop("disabled",this.value!=="selected"),this.value!=="selected"&&($(f).val(null).trigger("change"),p())});$(f).prop("disabled",$("input[name=table_filter_account_scope]:checked").val()!=="selected");
