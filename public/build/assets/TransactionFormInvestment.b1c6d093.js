import{T as j,M,a as U}from"./TransactionSchedule.6ec72524.js";import{B as P,g as F}from"./Button.f5acc136.js";import{a as E,h as f,o as c,b as l,k as d,d as e,t as i,w as r,m as h,F as v,f as b,s as T,g as p,e as y,n as k,u as S,x as Y,y as z,p as R,i as C,v as V,q as L}from"./app.1ea3d35e.js";import{D as N}from"./index.d8923a62.js";import{l as H,c as q,i as Q,b as w,p as A,t as G}from"./helpers.0d23fc7a.js";import{s as J}from"./select2.23b23e14.js";J();H(window.YAFFA.language);const K={components:{TransactionSchedule:j,MathInput:M,DatePicker:N,Button:P,AlertErrors:U},props:{action:String,initialCallback:{type:String,default:"create"},transaction:Object,simplified:{type:Boolean,default:!1},fromModal:{type:Boolean,default:!1}},data(){let t={};return t.form=new F({fromModal:this.fromModal,transaction_type:"Buy",config_type:"investment",date:q(),comment:null,schedule:!1,budget:!1,reconciled:!1,config:{},schedule_config:{frequency:"DAILY",interval:1}}),t.account_currency=null,t.investment_currency=null,t.csrfToken=window.csrfToken,t.callback=this.initialCallback,t.callbackOptions=[{value:"create",label:__("Add an other transaction"),enabled:!0},{value:"clone",label:__("Clone this transaction"),enabled:!0},{value:"show",label:__("Show this transaction"),enabled:!0},{value:"returnToPrimaryAccount",label:__("Return to selected account"),enabled:!0},{value:"returnToDashboard",label:__("Return to dashboard"),enabled:!0},{value:"back",label:__("Return to previous page"),enabled:!0}],t.locale=window.YAFFA.locale,t},computed:{total(){return(this.form.config.quantity||0)*(this.form.config.price||0)+(this.form.config.dividend||0)-((this.form.config.commission||0)+(this.form.config.tax||0))*this.transactionTypeSettings.amount_multiplier},transactionTypeSettings(){return this.transactionTypes.find(t=>t.name===this.form.transaction_type)||{}},currency(){return this.account_currency||this.investment_currency},activeCallbackOptions(){return this.callbackOptions.filter(t=>t.enabled)},datePickerInitialPage(){let t=this.form.date||new Date;return typeof t=="string"&&(t=new Date(t)),{year:t.getFullYear(),month:t.getMonth()}},isBaseSettingsEditsAllowed(){return["create","clone","finalize"].includes(this.action)}},created(){this.initializeTransaction(),this.transactionTypes=[{name:"Buy",quantity:!0,price:!0,dividend:!1,amount_multiplier:-1},{name:"Sell",quantity:!0,price:!0,dividend:!1,amount_multiplier:1},{name:"Add shares",quantity:!0,price:!1,dividend:!1,amount_multiplier:null},{name:"Remove shares",quantity:!0,price:!1,dividend:!1,amount_multiplier:null},{name:"Dividend",quantity:!1,price:!1,dividend:!0,amount_multiplier:1},{name:"Interest yield",quantity:!1,price:!1,dividend:!0,amount_multiplier:1}];const t=new URLSearchParams(window.location.search);t.get("account")&&(this.form.config.account_id=t.get("account")),this.form.action=this.action},mounted(){let t=this;$("#account").select2({ajax:{url:"/api/assets/account/investment",dataType:"json",delay:150,data:function(n){var s;return{q:n.term,transaction_type:t.form.transaction_type,currency_id:(s=t.investment_currency)==null?void 0:s.id,_token:t.csrfToken}},processResults:function(n){return{results:n}},cache:!0},selectOnClose:!1,placeholder:__("Select account"),allowClear:!0,width:"resolve",theme:"bootstrap-5",dropdownParent:$(document.getElementById("modal-transaction-form-investment")||document.querySelector("body"))}).on("select2:select",function(n){const s=new Event("change",{bubbles:!0,cancelable:!0});n.target.dispatchEvent(s),$.ajax({url:"/api/assets/account/"+n.params.data.id,data:{_token:t.csrfToken}}).done(u=>{t.account_currency=u.config.currency})}).on("select2:unselect",function(){t.account_id=null,t.account_currency=null,t.account_currency_id=null}),this.getDefaultAccountDetails(this.form.config.account_id),$("#investment").select2({ajax:{url:"/api/assets/investment",data:function(n){var s;return{q:n.term,currency_id:(s=t.account_currency)==null?void 0:s.id,_token:t.csrfToken}},dataType:"json",delay:150,processResults:function(n){return{results:n}},cache:!0},selectOnClose:!1,placeholder:__("Select investment"),allowClear:!0,width:"resolve",theme:"bootstrap-5",dropdownParent:$(document.getElementById("modal-transaction-form-investment")||document.querySelector("body"))}).on("select2:select",function(n){const s=new Event("change",{bubbles:!0,cancelable:!0});n.target.dispatchEvent(s),$.ajax({url:route("investment.getDetails",{investment:n.params.data.id}),data:{_token:t.csrfToken}}).done(function(u){t.investment_currency=u.currency})}).on("select2:unselect",function(){t.investment_id=null,t.investment_currency=null}),this.getDefaultInvestmentDetails(this.form.config.investment_id),this.syncScheduleStartDate(this.form.schedule_config.start_date),Q()},methods:{getDefaultAccountDetails(t){if(!t)return;const n=this;$.ajax({url:"/api/assets/account/"+this.form.config.account_id,data:{_token:n.csrfToken}}).done(s=>{$("#account").append(new Option(s.name,s.id,!0,!0)).trigger("change").trigger({type:"select2:select",params:{data:s}})})},getDefaultInvestmentDetails(t){if(!t)return;const n=this;$.ajax({url:route("investment.getDetails",{investment:t}),data:{_token:n.csrfToken}}).done(function(s){$("#investment").append(new Option(s.name,s.id,!0,!0)).trigger("change").trigger({type:"select2:select",params:{data:s}})})},copyDateObject(t){return t instanceof Date?t:t?new Date(t):null},initializeTransaction(){var t,n,s,u,_,a;this.transaction&&Object.keys(this.transaction).length>0&&(this.form.id=this.transaction.id,this.form.transaction_type=(t=this.transaction.transaction_type)==null?void 0:t.name,this.form.date=this.copyDateObject(this.transaction.date),this.form.comment=this.transaction.comment,this.form.schedule=this.transaction.schedule,this.form.budget=this.transaction.budget,this.form.reconciled=this.transaction.reconciled,this.form.config.quantity=(n=this.transaction.config)==null?void 0:n.quantity,this.form.config.price=(s=this.transaction.config)==null?void 0:s.price,this.form.config.commission=(u=this.transaction.config)==null?void 0:u.commission,this.form.config.tax=(_=this.transaction.config)==null?void 0:_.tax,this.form.config.dividend=(a=this.transaction.config)==null?void 0:a.dividend,this.form.config.account_id=this.transaction.config.account_id,this.form.config.investment_id=this.transaction.config.investment_id,this.transaction.transaction_schedule&&(this.form.schedule_config.frequency=this.transaction.transaction_schedule.frequency,this.form.schedule_config.count=this.transaction.transaction_schedule.count,this.form.schedule_config.interval=this.transaction.transaction_schedule.interval,this.form.schedule_config.start_date=this.copyDateObject(this.transaction.transaction_schedule.start_date),this.form.schedule_config.next_date=this.copyDateObject(this.transaction.transaction_schedule.next_date),this.form.schedule_config.automatic_recording=this.transaction.transaction_schedule.automatic_recording,this.form.schedule_config.end_date=this.copyDateObject(this.transaction.transaction_schedule.end_date),this.form.schedule_config.inflation=this.transaction.transaction_schedule.inflation),this.action==="replace"&&(this.form.original_schedule_config={},this.form.original_schedule_config.frequency=this.form.schedule_config.frequency,this.form.original_schedule_config.count=this.form.schedule_config.count,this.form.original_schedule_config.interval=this.form.schedule_config.interval,this.form.original_schedule_config.inflation=this.form.schedule_config.inflation,this.form.original_schedule_config.start_date=this.copyDateObject(this.form.schedule_config.start_date),this.form.original_schedule_config.automatic_recording=this.form.schedule_config.automatic_recording,this.form.original_schedule_config.next_date=void 0,this.form.schedule_config.start_date=w(),this.form.schedule&&(this.form.schedule_config.next_date=w()),this.form.original_schedule_config.end_date=new Date(w().getTime()-24*60*60*1e3))),this.form.action=this.action},transactionTypeChanged(){const t=this.transactionTypeSettings;t.quantity||(this.form.config.quantity=null),t.price||(this.form.config.price=null),t.dividend||(this.form.config.dividend=null)},loadCallbackUrl(t){if(this.callback==="returnToDashboard"){location.href=window.route("home");return}if(this.callback==="new"){location.href=window.route("transaction.create",{type:"investment"});return}if(this.callback==="clone"){location.href=window.route("transaction.open",{transaction:t,action:"clone"});return}if(this.callback==="returnToPrimaryAccount"){location.href=window.route("account.history",{account:this.form.config.account_id});return}if(this.callback==="returnToSecondaryAccount"){location.href=window.route("account.history",{account:this.form.config.account_id});return}document.referrer?location.href=document.referrer:history.back()},onCancel(){return confirm(__("Are you sure you want to discard any changes?"))&&this.$emit("cancel"),!1},onSubmit(){if(this.action==="edit"){this.form.patch(window.route("api.transactions.updateInvestment",{transaction:this.form.id}),this.form).then(t=>{this.$emit("success",A(t.data.transaction),{callback:this.callback})});return}this.form.post(window.route("api.transactions.storeInvestment"),this.form).then(t=>{this.$emit("success",A(t.data.transaction),{callback:this.callback})})},syncScheduleStartDate(t){if(!this.form.original_schedule_config||!this.$refs.scheduleOriginal||this.$refs.scheduleOriginal.allowCustomization)return;let n=new Date(t);n.setDate(n.getDate()-1),this.form.original_schedule_config.end_date=q(n)},clearInvestmentDropdown(){$("#investment").val(null).trigger("change"),this.investment_currency=null},toFormattedCurrency:G},watch:{"form.schedule_config.start_date":function(t){this.syncScheduleStartDate(t)},transaction(t){this.form.reset(),this.initializeTransaction(),this.getDefaultAccountDetails(t.config.account_id),t.config.investment_id?this.getDefaultInvestmentDetails(t.config.investment_id):this.clearInvestmentDropdown()}}},W={id:"transactionFormInvestment"},X={class:"row"},Z={class:"col-md-4"},x={class:"card mb-3"},tt={class:"card-header d-flex justify-content-between"},et={class:"card-title"},nt=["title"],ot={class:"card-body"},st={class:"row"},it={class:"col-md-8 mb-2"},at={class:"form-group"},ct={for:"transaction_type",class:"form-label"},lt=["disabled"],rt=["value"],dt={key:0,class:"col d-flex justify-content-between gap-2 mb-0"},ut=["disabled"],mt=["title","data-toggle"],ft={class:"col-md-8"},ht={class:"card mb-3"},_t={class:"card-header"},gt={class:"card-title"},vt={class:"card-body"},bt={class:"row"},pt={class:"col-6 col-sm-2 mb-3 mb-sm-0 d-flex justify-content-center"},yt=["disabled"],kt={class:"btn btn-outline-success",for:"checkbox-investment-transaction-reconciled"},wt={class:"block-label",for:"investment-date"},Dt=["disabled","value"],Tt={for:"investment-comment",class:"block-label"},St={class:"row"},Ct={class:"col-md-4"},Vt={class:"card mb-3"},qt={class:"card-header"},At={class:"card-title"},It={class:"card-body"},Bt={class:"row mb-3"},Ot={class:"col-12 mb-3"},jt={class:"form-group"},Mt={for:"account",class:"form-label"},Ut={class:"col-12 mb-2"},Pt={class:"form-group"},Ft={for:"investment",class:"form-label"},Et={class:"row"},Yt={class:"col-8"},zt={class:"col-4"},Rt={key:0,class:"me-1",dusk:"transaction-total-value"},Lt={key:1},Nt={class:"col-md-8"},Ht={class:"card mb-3"},Qt={class:"card-header"},Gt={class:"card-title"},Jt={class:"card-body"},Kt={class:"row"},Wt={class:"col-md-6 mb-3"},Xt={class:"form-group"},Zt={for:"transaction_quantity",class:"form-label"},$t={class:"col-md-6 mb-3"},xt={class:"form-group"},te={for:"transaction_price",class:"form-label"},ee={class:"row"},ne={class:"col-md-6 mb-3"},oe={class:"form-group"},se={for:"transaction_commission",class:"form-label"},ie={class:"col-md-6 mb-3"},ae={class:"form-group"},ce={for:"transaction_tax",class:"form-label"},le={class:"row"},re={class:"col-md-6"},de={class:"form-group"},ue={for:"transaction_dividend",class:"form-label"},me={class:"card mb-3"},fe={class:"card-body"},he={class:"row"},_e={class:"d-none d-md-block col-md-10"},ge={dusk:"action-after-save-desktop-button-group"},ve={class:"btn-group"},be={class:"btn btn-secondary",disabled:""},pe=["value"],ye={class:"col-12 d-block d-md-none"},ke={class:"form-label block-label",for:"callback-selector-mobile-investment"},we=["value"],De={class:"col-12 col-md-2 text-end align-self-end"};function Te(t,n,s,u,_,a){const I=f("AlertErrors"),B=f("DatePicker"),m=f("MathInput"),D=f("transaction-schedule"),O=f("Button");return c(),l("div",W,[d(I,{form:t.form,message:t.__("There were some problems with your input.")},null,8,["form","message"]),e("form",{"accept-charset":"UTF-8",onSubmit:n[16]||(n[16]=L((...o)=>a.onSubmit&&a.onSubmit(...o),["prevent"])),autocomplete:"off"},[e("div",X,[e("div",Z,[e("div",x,[e("div",tt,[e("div",et,i(t.__("Settings")),1),e("span",{class:"fa fa-info-circle text-primary","data-bs-toggle":"tooltip","data-bs-placement":"right",title:t.__("These settings cannot be changed after saving the transaction.")},null,8,nt)]),e("div",ot,[e("div",st,[e("div",it,[e("div",at,[e("label",ct,i(t.__("Transaction type")),1),r(e("select",{id:"transaction_type",class:"form-select","onUpdate:modelValue":n[0]||(n[0]=o=>t.form.transaction_type=o),disabled:!a.isBaseSettingsEditsAllowed,onChange:n[1]||(n[1]=o=>a.transactionTypeChanged(o))},[(c(!0),l(v,null,b(t.transactionTypes,o=>(c(),l("option",{key:o.name,value:o.name},i(o.name),9,rt))),128))],40,lt),[[h,t.form.transaction_type]])])]),s.simplified?y("",!0):(c(),l("div",dt,[r(e("input",{class:"btn-check",disabled:t.form.reconciled||!a.isBaseSettingsEditsAllowed,id:"checkbox-investment-transaction-schedule",type:"checkbox",autocomplete:"off",value:"1","onUpdate:modelValue":n[2]||(n[2]=o=>t.form.schedule=o)},null,8,ut),[[T,t.form.schedule]]),e("label",{class:"btn btn-outline-dark w-100",dusk:"checkbox-transaction-schedule",for:"checkbox-investment-transaction-schedule",title:s.action==="replace"?t.__("You cannot change schedule settings for this type of action"):"","data-toggle":s.action==="replace"?"tooltip":""},[n[17]||(n[17]=e("span",{class:"fa-solid fa-arrows-rotate"},null,-1)),n[18]||(n[18]=e("br",null,null,-1)),p(" "+i(t.__("Scheduled")),1)],8,mt)]))])])])]),e("div",ft,[e("div",ht,[e("div",_t,[e("div",gt,i(t.__("Properties")),1)]),e("div",vt,[e("div",bt,[e("div",pt,[r(e("input",{class:"btn-check",disabled:t.form.schedule,id:"checkbox-investment-transaction-reconciled",type:"checkbox",autocomplete:"off",value:"1","onUpdate:modelValue":n[3]||(n[3]=o=>t.form.reconciled=o)},null,8,yt),[[T,t.form.reconciled]]),e("label",kt,[n[19]||(n[19]=e("span",{class:"fa fa-check"},null,-1)),n[20]||(n[20]=e("br",null,null,-1)),p(" "+i(t.__("Reconciled")),1)])]),e("div",{class:k(["col-6 col-sm-2 mb-3 mb-sm-0",{"has-error":t.form.errors.has("date")}])},[e("label",wt,i(t.__("Date")),1),d(B,{columns:2,"initial-page":a.datePickerInitialPage,masks:{L:"YYYY-MM-DD",modelValue:"YYYY-MM-DD"},mode:"date",popover:{visibility:"click",showDelay:0,hideDelay:0},modelValue:t.form.date,"onUpdate:modelValue":n[4]||(n[4]=o=>t.form.date=o),modelModifiers:{string:!0}},{default:S(({inputValue:o,inputEvents:g})=>[e("input",Y({class:"form-control",disabled:t.form.schedule,id:"investment-date",value:o},z(g,!0)),null,16,Dt)]),_:1},8,["initial-page","modelValue"])],2),e("div",{class:k(["col-12 col-sm-8 mb-0",t.form.errors.has("comment")?"has-error":""])},[e("label",Tt,i(t.__("Comment")),1),r(e("input",{class:"form-control",id:"investment-comment",maxlength:"255",type:"text","onUpdate:modelValue":n[5]||(n[5]=o=>t.form.comment=o)},null,512),[[R,t.form.comment]])],2)])])])])]),e("div",St,[e("div",Ct,[e("div",Vt,[e("div",qt,[e("div",At,i(t.__("Details")),1)]),e("div",It,[e("div",Bt,[e("div",Ot,[e("div",jt,[e("label",Mt,i(t.__("Account")),1),r(e("select",{class:"form-select",id:"account","onUpdate:modelValue":n[6]||(n[6]=o=>t.form.config.account_id=o),style:{width:"100% !important"}},null,512),[[h,t.form.config.account_id]])])]),e("div",Ut,[e("div",Pt,[e("label",Ft,i(t.__("Investment")),1),r(e("select",{class:"form-control",id:"investment","onUpdate:modelValue":n[7]||(n[7]=o=>t.form.config.investment_id=o),style:{width:"100% !important"}},null,512),[[h,t.form.config.investment_id]])])])]),e("dl",Et,[e("dt",Yt,i(t.__("Total cashflow value")),1),e("dd",zt,[a.currency?(c(),l("span",Rt,i(a.toFormattedCurrency(a.total,this.locale,a.currency)),1)):(c(),l("span",Lt,i(a.total),1))])])])])]),e("div",Nt,[e("div",Ht,[e("div",Qt,[e("div",Gt,i(t.__("Details")),1)]),e("div",Jt,[e("div",Kt,[e("div",Wt,[e("div",Xt,[e("label",Zt,i(t.__("Quantity")),1),d(m,{class:"form-control",id:"transaction_quantity",modelValue:t.form.config.quantity,"onUpdate:modelValue":n[8]||(n[8]=o=>t.form.config.quantity=o),disabled:!a.transactionTypeSettings.quantity},null,8,["modelValue","disabled"])])]),e("div",$t,[e("div",xt,[e("label",te,i(t.__("Price")),1),d(m,{class:"form-control",id:"transaction_price",modelValue:t.form.config.price,"onUpdate:modelValue":n[9]||(n[9]=o=>t.form.config.price=o),disabled:!a.transactionTypeSettings.price},null,8,["modelValue","disabled"])])])]),e("div",ee,[e("div",ne,[e("div",oe,[e("label",se,i(t.__("Commission")),1),d(m,{class:"form-control",id:"transaction_commission",modelValue:t.form.config.commission,"onUpdate:modelValue":n[10]||(n[10]=o=>t.form.config.commission=o)},null,8,["modelValue"])])]),e("div",ie,[e("div",ae,[e("label",ce,i(t.__("Tax")),1),d(m,{class:"form-control",id:"transaction_tax",modelValue:t.form.config.tax,"onUpdate:modelValue":n[11]||(n[11]=o=>t.form.config.tax=o)},null,8,["modelValue"])])])]),e("div",le,[e("div",re,[e("div",de,[e("label",ue,i(t.__("Dividend")),1),d(m,{class:"form-control",id:"transaction_dividend",modelValue:t.form.config.dividend,"onUpdate:modelValue":n[12]||(n[12]=o=>t.form.config.dividend=o),disabled:!a.transactionTypeSettings.dividend},null,8,["modelValue","disabled"])])])])])])])]),t.form.schedule?(c(),C(D,{key:0,isSchedule:t.form.schedule,isBudget:!1,schedule:t.form.schedule_config,form:t.form},null,8,["isSchedule","schedule","form"])):y("",!0),t.form.schedule&&s.action==="replace"?(c(),C(D,{key:1,withCheckbox:!0,title:t.__("Update base schedule"),allowCustomization:!1,ref:"scheduleOriginal",isSchedule:t.form.schedule,isBudget:!1,schedule:t.form.original_schedule_config,form:t.form},null,8,["title","isSchedule","schedule","form"])):y("",!0),e("div",me,[e("div",fe,[e("div",he,[e("div",_e,[r(e("div",ge,[e("div",ve,[e("button",be,i(t.__("Action after saving")),1),(c(!0),l(v,null,b(a.activeCallbackOptions,o=>(c(),l("button",{key:o.id,class:k(["btn btn-outline-dark",{active:t.callback===o.value}]),type:"button",value:o.value,onClick:n[13]||(n[13]=g=>t.callback=g.currentTarget.getAttribute("value"))},i(o.label),11,pe))),128))])],512),[[V,!s.fromModal]])]),e("div",ye,[r(e("div",null,[e("label",ke,i(t.__("Action after saving")),1),r(e("select",{class:"form-control","onUpdate:modelValue":n[14]||(n[14]=o=>t.callback=o),id:"callback-selector-mobile-investment"},[(c(!0),l(v,null,b(a.activeCallbackOptions,o=>(c(),l("option",{key:o.id,value:o.value},i(o.label),9,we))),128))],512),[[h,t.callback]])],512),[[V,!s.fromModal]])]),e("div",De,[e("button",{class:"btn btn-sm btn-default",onClick:n[15]||(n[15]=(...o)=>a.onCancel&&a.onCancel(...o)),type:"button"},i(t.__("Cancel")),1),d(O,{class:"btn btn-primary ms-2",disabled:t.form.busy,form:t.form,id:"transactionFormInvestment-Save"},{default:S(()=>[p(i(t.__("Save")),1)]),_:1},8,["disabled","form"])])])])])],32)])}const Be=E(K,[["render",Te],["__scopeId","data-v-85023fa1"]]);export{Be as T};
