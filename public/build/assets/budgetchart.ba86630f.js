import{u as E,c as I,D as L,V as q,d as X,L as T,a as U,h as R,b as P,t as z,X as N}from"./animated.b7973092.js";import{t as O}from"./kelly.2c029627.js";import{t as f,d as y,b as H,c as Q}from"./dataTableHelper.f10b8b21.js";import{p as V,d as W,i as Z}from"./helpers.0d23fc7a.js";import"./dataTables.bootstrap5.9fbefa5d.js";import"./select2.23b23e14.js";import"./tslib.es6.598c7c7a.js";import"./app.1ea3d35e.js";const h="#accountList",c="#categoryTree",G=(e,n)=>e.reduce((t,o)=>t+o[n],0)/e.length,K=(e,n)=>{if(e.length===0)return e;let t=12;n==="quarter"?t=4*3:n==="year"&&(t=5*12);let o=null;for(let a=e.length;a>0;a--)if(e[a-1].actual){o=e[a-1].date;break}return o||(o=e[e.length-1].date),e.map(function(a,u){if(a.date>o)return u>0&&(a.movingAverage=e[u-1].movingAverage),a;const r=new Date(a.date.getTime());r.setMonth(r.getMonth()-t);const i=a.date,l=e.filter(function(s){return s.date>=r&&s.date<=i});return a.movingAverage=G(l,"actual"),a})},b=document.getElementById("reload");E(z);E(O);window.chart=I("chartdiv",N);chart.numberFormatter.intlLocales=window.YAFFA.locale;chart.numberFormatter.numberFormat={style:"currency",currency:window.YAFFA.baseCurrency.iso_code,minimumFractionDigits:0};const p=chart.xAxes.push(new L);p.dataFields.category="period";p.baseInterval={timeUnit:"month",count:1};p.dateFormats.setKey("month","yyyy MMM");chart.yAxes.push(new q);const v=chart.series.push(new X);v.dataFields.valueY="actual";v.dataFields.dateX="date";v.name=__("Actual");v.tooltipText="[bold]"+__("Actual")+":[/] {valueY}";const _=chart.series.push(new T);_.strokeWidth=3;_.strokeDasharray="8,4";_.dataFields.valueY="budget";_.dataFields.dateX="date";_.name=__("Budget");_.tooltipText="[bold]"+__("Budget")+":[/] {valueY}";const w=chart.series.push(new T);w.strokeWidth=3;w.dataFields.valueY="movingAverage";w.dataFields.dateX="date";w.name=__("Moving average");w.tooltipText="[bold]"+__("Moving average")+":[/] {valueY}";const x=new U;x.series.push(_);x.series.push(v);x.series.push(w);chart.scrollbarX=x;chart.legend=new R;chart.cursor=new P;const M=document.getElementById("btnZoomIn");M&&M.addEventListener("click",function(){const e=new Date;p.zoomToDates(new Date(e.setMonth(e.getMonth()-13)),new Date(e.setMonth(e.getMonth()+26)))});let k=[],F=function(){b.disabled=!0;const e=$(c).jstree()?$(c).jstree("get_checked",!0):[];$.ajax({url:window.route("api.reports.budgetchart"),data:{categories:e.map(n=>n.id),accountSelection:$("input[name=table_filter_account_scope]:checked").val(),accountEntity:$(h).val()}}).done(function(n){n=n.map(function(o){return o.date=new Date(o.period),o}),k=n.slice();let t="month";e.some(function(o){if(o.original.default_aggregation==="quarter")return t="quarter",!1;if(o.original.default_aggregation==="year")return t="year",!0}),document.querySelector('input[name="chart_time_interval"][value="'+t+'"]').checked=!0,B(k)}).always(function(){b.disabled=!1}),window.table.ajax.reload(function(){Z()})};function B(e){var o;if(e.length===0){chart.data=[],chart.invalidateData();return}const n=((o=document.querySelector('input[name="chart_time_interval"]:checked'))==null?void 0:o.value)||"month";let t;if(n==="quarter"){t=e.reduce((i,l)=>{const s=Math.floor(l.date.getMonth()/3),g=i.find(S=>S.date.getFullYear()===l.date.getFullYear()&&Math.floor(S.date.getMonth()/3)===s);return typeof g>"u"?(i.push({date:new Date(l.date.getFullYear(),s*3),period:l.date.getFullYear()+" Q"+(s+1),actual:l.actual,budget:l.budget}),i):(g.actual||(g.actual=0),g.budget||(g.budget=0),g.actual+=l.actual,g.budget+=l.budget,i)},[]);const a=t[0].date,u=t[t.length-1].date;let r=new Date(a);for(;r<u;)t.find(i=>i.date.getFullYear()===r.getFullYear()&&Math.floor(i.date.getMonth()/3)===Math.floor(r.getMonth()/3))||t.push({date:new Date(r),period:r.getFullYear()+" Q"+(Math.floor(r.getMonth()/3)+1),actual:0,budget:0}),r.setMonth(r.getMonth()+3);p.baseInterval={timeUnit:"month",count:3}}else if(n==="year"){t=e.reduce((i,l)=>{const s=i.find(g=>g.date.getFullYear()===l.date.getFullYear());return typeof s>"u"?(i.push({date:new Date(l.date.getFullYear(),0),period:l.date.getFullYear().toString(),actual:l.actual,budget:l.budget}),i):(s.actual||(s.actual=0),s.budget||(s.budget=0),s.actual+=l.actual,s.budget+=l.budget,i)},[]);const a=t[0].date,u=t[t.length-1].date;let r=new Date(a);for(;r<u;)t.find(i=>i.date.getFullYear()===r.getFullYear())||t.push({date:new Date(r),period:r.getFullYear().toString(),actual:0,budget:0}),r.setFullYear(r.getFullYear()+1);p.baseInterval={timeUnit:"year",count:1}}else{t=e.slice();const a=t[0].date,u=t[t.length-1].date;let r=new Date(a);for(;r<u;)t.find(i=>i.date.getFullYear()===r.getFullYear()&&i.date.getMonth()===r.getMonth()&&i.date.getDate()===r.getDate())||t.push({date:new Date(r),period:r.toISOString().slice(0,7),actual:0,budget:0}),r.setMonth(r.getMonth()+1);p.baseInterval={timeUnit:"month",count:1}}t.sort((a,u)=>a.date-u.date),t=K(t,n),chart.data=t,chart.invalidateData()}b.addEventListener("click",F);document.querySelectorAll('input[name="chart_time_interval"]').forEach(function(e){e.addEventListener("change",function(){B(k)})});let j=!0;const D="#table";window.table=$(D).DataTable({ajax:{url:window.route("api.transactions.getScheduledItems",{type:"any"}),type:"GET",dataSrc:function(e){return e.transactions?e.transactions.map(V).map(W):[]},data:function(){return j?(j=!1,{categories:[],category_required:1}):Object.assign({},{categories:$(c).jstree()?$(c).jstree("get_checked"):[],category_required:1,accountSelection:$("input[name=table_filter_account_scope]:checked").val(),accountEntity:$(h).val()})}},columns:[f.dateFromCustomField("transaction_schedule.start_date",__("Start date"),window.YAFFA.locale),{data:"transaction_schedule.rule",title:__("Schedule"),render:function(e){return e.toText()}},f.dateFromCustomField("transaction_schedule.next_date",__("Next date"),window.YAFFA.locale),f.iconFromBooleanField("schedule",__("Schedule")),f.iconFromBooleanField("budget",__("Budget")),f.iconFromBooleanField("transaction_schedule.active",__("Active")),{data:"transaction_type.type",title:__("Type"),render:function(e,n){return n==="filter"?e:e==="standard"?'<i class="fa fa-money text-primary" title="'+__("Standard")+'"></i>':'<i class="fa fa-line-chart text-primary" title="'+__("Investment")+'"></i>'},className:"text-center"},f.payee,f.category,f.amount,f.extra,{data:"id",title:__("Actions"),render:function(e,n,t){return y(e,"edit")+y(e,"clone")+y(e,"replace")+y(e,"delete")+(t.schedule?'<a href="'+window.route("transaction.open",{transaction:e,action:"enter"})+'" class="btn btn-xs btn-success" title="'+__("Edit and insert instance")+'"><i class="fa fa-fw fa-pencil"></i></a> <button class="btn btn-xs btn-warning data-skip" data-id="'+e+'" type="button" title="'+__("Skip current schedule")+'"><i class="fa fa-fw fa-forward"></i></i></button> ':"")},className:"dt-nowrap",orderable:!1,searchable:!1}],createdRow:function(e,n){!n.transaction_schedule.next_date||(n.transaction_schedule.next_date<new Date(new Date().setHours(0,0,0,0))?$(e).addClass("danger"):n.transaction_schedule.next_date<new Date(new Date().setHours(24,0,0,0))&&$(e).addClass("warning"))},order:[[0,"asc"]],deferRender:!0,scrollY:"400px",scrollCollapse:!0,stateSave:!1,processing:!0,paging:!1});H(D);Q(D);let d={categories:{},account:void 0,ready:function(){for(let e in d.categories)if(d.categories[e]===!1)return!1;return d.account!==!1}};const Y=new URLSearchParams(window.location.search),C=Y.getAll("categories[]").map(e=>parseInt(e));C.forEach(e=>d.categories[e]=!1);const A=Y.has("accountEntity")?parseInt(Y.get("accountEntity")):void 0;typeof A<"u"&&(d.account=!1);let m=function(){let e=new URL(window.location.origin+window.location.pathname);$(h).val()&&e.searchParams.append("accountEntity",$(h).val()),$(c).jstree("get_checked").forEach(n=>e.searchParams.append("categories[]",n)),window.history.pushState("","",e.toString()),b.disabled=$(c).jstree("get_checked").length===0};$(c).jstree({core:{data:function(e,n){fetch("/api/assets/categories?withInactive=1").then(t=>t.json()).then(t=>{let o=t.map(function(a){return d.categories[a.id]!==void 0&&(d.categories[a.id]=!0),{id:a.id,parent:a.parent_id||"#",default_aggregation:a.default_aggregation,text:a.active?a.name:'<span class="text-muted" title="'+__("Inactive")+'">'+a.name+"</span>",full_name:a.full_name,icon:a.parent?a.active?"fa fa-check text-success":"fa fa-remove text-danger":"fa fa-folder text-info",state:{selected:C.includes(a.id)}}});n.call(this,o)})},themes:{dots:!1}},plugins:["checkbox"],checkbox:{keep_selected_style:!1}}).on("select_node.jstree",m).on("deselect_node.jstree",m).on("ready.jstree",function(){$(c).jstree("get_checked").length>0?d.ready()&&F():b.disabled=!0});$(h).select2({theme:"bootstrap-5",ajax:{url:"/api/assets/account",dataType:"json",delay:150,data:function(e){return{q:e.term,withInactive:!0}},processResults:function(e){return{results:e.map(function(n){return{id:n.id,text:n.name}})}},cache:!0},placeholder:__("Select account"),allowClear:!0}).on("select2:select",m).on("select2:unselect",m);typeof A<"u"?$.ajax({url:"/api/assets/account/"+A,data:{_token:window.csrfToken}}).done(e=>{$(h).append(new Option(e.name,e.id,!0,!0)).trigger("change").trigger({type:"select2:select",params:{data:{id:e.id,name:e.name}}}),d.account=!0,d.ready()&&$(c).jstree("get_checked").length>0&&F()}):d.ready()&&$(c).jstree("get_checked").length>0&&F();document.getElementById("all").addEventListener("click",function(){$(c).jstree("check_all"),m()});document.getElementById("clear").addEventListener("click",function(){$(c).jstree("uncheck_all"),m()});$("input[name=table_filter_account_scope]").on("change",function(){$(h).prop("disabled",this.value!=="selected"),this.value!=="selected"&&($(h).val(null).trigger("change"),m())});$(h).prop("disabled",$("input[name=table_filter_account_scope]:checked").val()!=="selected");
